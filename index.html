<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Nix(OS)</title> <!-- Nix.* -->

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Nix(OS) - The Power To Revolutionize! <!-- .element: style="font-size:2em" -->
            <!-- Totally not stolen from @Profpatsch... :D -->

            ![NixOS logo](img/nixos.svg)

            The Purely Functional Linux Distribution
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Main components

            - Nix (package manager)
            - Nixpkgs (Nix packages collection)
            - NixOS (operating system)
            - NixOps (DevOps / cloud deployment tool)
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # ISO/OSI model

            TODO: Find image from Profpatsch or Nixcon or recreate it.
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Other tools

            - Hydra (Nix based continuous build system)
            - Disnix (distributed services deployment)
            - PatchELF (change dynamic linker and RPATH)
            - {cabal,go,node,pip,python,pypi,composer,hex,bower,vim,...}2nix
            Notes:
            - nixcrates, cargo2nix, elm2nix, ...
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Problems of classical package managers

            - Different versions of a binary
            - Package conflicts
            - State -> nondeterministic builds -> not reproducible
            - No rollbacks
            - No configuration management (NixOS)
            - Updates/configuration changes destructively update the system
              state (overwriting files in sequence -> temporary inconsistency)
            Notes:
            - Apps might have an undefined behaviour or crash when launched
              during an upgrade + possibility of permanent damage when
              interrupted (e.g. even unbootable!).
            - Incomplete dependency specifications (no isolated build
              environment)
            - Nominal dependency specifications (only name and optionally
              version)
            - Configuration files not controlled by the package manager.
            - Upgrading modified configuration files is problematic.
            - Binaries = global variables (e.g. /bin/bash)
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Nix(OS)

            - Atomic upgrades/rollbacks (software & configuration)
            - Multiple versions of a package (side-by-side, e.g. testing a new
              Apache version)
            - Deterministic & Reproducible builds
            - Reliable upgrades (and rollbacks - configuration bound to correct
              software version + service reloads/restarts)
            - Reliable channel upgrades/rollbacks (e.g. 17.03 -> 17.09)
            - Unprivileged users can securely install software
            Notes:
            - Next slide: Declarative configuration management
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Being functional

            - Classically: Imperative configuration
              - Stateful changes (-> dependency hell, inconsistent states, etc.)
            - NixOS: Declarative configuration
              - Packages/Configuration = immutable values
              - (Complete) rebuilds instead of destructive updates
              - Referential transparency (~an expression always evaluates to the
                same result)
            Notes:
            - Referential transparency: An expression always evaluates to the
              same result in any contex (no side effects like (uncontrolled)
              imperative updates).
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Problems

            - Not all packages are reproducible (2016: 12.8%)
            - Running pre-compiled binaries
            - No GUI for package/configuration management
            - No LTS releases or super stable (i.e. old :P) branches
            - Not all use-cases or configuration options supported
              - Some tricks available + PRs welcome ;)
            - Lacking manpower/workforce (e.g. security, documentation)
            - Scripts with hard-coded paths don't work
            Notes:
            - 13 Dec 2016: "Currently, out of 36550 build steps in a full NixOS
            evaluation, only 4699 (12.8%) were detected as non-deterministic.
            (Note that Hydra can only detect the presence of non-determinism,
            not its absence)." - Eelco
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Nix
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Nix expressions / Nix expression language

            - A DSL (not a GPL!)
              - Describes graphs of build actions ("derivations")
              - Packages, compositions of packages, configurations, ...
            - Dynamically typed ("Nix won't be complete until it has static
              typing." @edolstra) - https://typing-nix.regnat.ovh/
            - Lazy (a very important feature!)
            - Purely functional (no side-effects, immutable store)
            - Turing complete (e.g. Dhall is not ->
              [dhall-nix](https://github.com/dhall-lang/dhall-nix))
            Notes:
            - DSL vs GPL: MD5 collisions by @Azlig (Chromium updater) :D
            - "Config files shouldn't be Turing complete" (-> always terminate)
            - Dhall is explicitly typed, evaluated, and configuration files can
              be reduced to a normal form
            <!-- TODO:
              - Bad evaluation errors? :D
                - Missing typing
                - Error in anonymous function at unknown file?
              - Evaluated vs interpreted?
              - Bugs? :D (e.g. a-b)
            -->
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Nixpkgs
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # An example Nix package (pgpdump) <!-- .element: style="font-size:1.5em" -->

            ```nix
            pgpdump = callPackage ../tools/security/pgpdump { };
            ```

            ```nix
            { stdenv, fetchFromGitHub
            , supportCompressedPackets ? true, zlib, bzip2
            }:

            stdenv.mkDerivation rec {
              name = "pgpdump-${version}";
              version = "0.32";

              src = fetchFromGitHub {
                owner = "kazu-yamamoto";
                repo = "pgpdump";
                rev = "v${version}";
                sha256 = "1ip7q5sgh3nwdqbrzpp6sllkls5kma98kns53yspw1830xi1n8xc";
              };

              buildInputs = stdenv.lib.optionals supportCompressedPackets [ zlib bzip2 ];

              meta = with stdenv.lib; {
                description = "A PGP packet visualizer";
                longDescription = ''
                  pgpdump is a PGP packet visualizer which displays the packet format of
                  OpenPGP (RFC 4880) and PGP version 2 (RFC 1991).
                '';
                homepage = http://www.mew.org/~kazu/proj/pgpdump/en/;
                license = licenses.bsd3;
                platforms = platforms.linux;
                maintainers = with maintainers; [ primeos ];
              };
            }
            ```
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # nix-env
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # NixOS
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # An example NixOS module <!-- .element: style="font-size:1.5em" -->

            ```nix
            { config, lib, pkgs, ... }:

            with lib;

            let
              cfg = config.programs.vim;
            in {
              options.programs.vim = {
                defaultEditor = mkOption {
                  type = types.bool;
                  default = false;
                  description = ''
                    When enabled, installs vim and configures vim to be the default editor
                    using the EDITOR environment variable.
                  '';
                };
              };

              config = mkIf cfg.defaultEditor {
                    environment.systemPackages = [ pkgs.vim ];
                    environment.variables = { EDITOR = mkOverride 900 "vim"; };
              };
            }

            ```
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # An example NixOS configuration <!-- .element: style="font-size:1.5em" -->
            <!-- TODO: More awesome stuff? :) -->

            ```nix
            { config, pkgs, ... }:

            {
              system.stateVersion = "17.09";

              nix.useSandbox = true;

              boot.kernelPackages = pkgs.linuxPackages_latest;

              i18n = {
                consoleFont = "Lat2-Terminus16";
                consoleKeyMap = "de";
                defaultLocale = "en_US.UTF-8";
              };

              time.timeZone = "Europe/Berlin";

              environment = {
                systemPackages = with pkgs; [
                  # Core
                  vim_configurable gitAndTools.gitFull wget
                  # Monitoring
                  htop python3Packages.glances
                  # Tools
                  time file tree lsof
                  pciutils hdparm zip unzip
                  # Network
                  inetutils bind.dnsutils
                  tcpdump
                ];
                variables = {
                  EDITOR = "vim";
                };
              };

              programs.bash.enableCompletion = true;
            }
            ```
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # NixOps
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # nix-shell
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # nix-repl
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # Nixpkgs overlays
          </textarea>
        </section>
        <section data-markdown data-separator-notes="^Notes:">
          <textarea data-template>
            # NixUP & co.
          </textarea>
        </section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ],
        width: 1080,
        height: 720
      });
    </script>
  </body>
</html>
